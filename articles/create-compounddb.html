<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creating CompoundDb annotation resources • CompoundDb</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Creating CompoundDb annotation resources">
<meta property="og:description" content="CompoundDb">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CompoundDb</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CompoundDb-usage.html">Usage of Annotation Resources with the CompoundDb Package</a>
    </li>
    <li>
      <a href="../articles/create-compounddb.html">Creating CompoundDb annotation resources</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/EuracBiomedicalResearch/CompoundDb/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="create-compounddb_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Creating CompoundDb annotation resources</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EuracBiomedicalResearch/CompoundDb/blob/master/vignettes/create-compounddb.Rmd"><code>vignettes/create-compounddb.Rmd</code></a></small>
      <div class="hidden name"><code>create-compounddb.Rmd</code></div>

    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Authors</strong>: Johannes Rainer<br><strong>Modified</strong>: 2021-01-12 14:41:16<br><strong>Compiled</strong>: Tue Jan 12 15:01:15 2021</p>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Chemical compound annotation and information can be retrieved from a variety of sources including <a href="http://www.hmdb.ca">HMDB</a>, <a href="http://www.lipidmaps.org">LipidMaps</a> or <a href="https://www.ebi.ac.uk/chebi">ChEBI</a>. The <code>CompoundDb</code> package provides functionality to extract data relevant for (chromatographic) peak annotations in metabolomics/lipidomics experiments from these sources and to store it into a common format (i.e. an <code>CompDb</code> object/database). This vignette describes how such <code>CompDb</code> objects can be created exemplified with package-internal test files that represent data subsets from some annotation resources.</p>
<p>The R object to represent the compound annotation is the <code>CompDb</code> object. Each object (respectively its database) is supposed to contain and provide annotations from a single source (e.g. HMDB or LipidMaps) but it is also possible to create cross-source databases too.</p>
</div>
<div id="create-a-compdb-object-for-hmdb" class="section level1">
<h1 class="hasAnchor">
<a href="#create-a-compdb-object-for-hmdb" class="anchor"></a>Create a <code>CompDb</code> object for HMDB</h1>
<p>The <code>CompDb</code> package provides the <code>compound_tbl_sdf</code> and the <code>compound_tbl_lipidblast</code> functions to extract relevant compound annotation from files in SDF (structure-data file) format or in the json files from LipidBlast (<a href="http://mona.fiehnlab.ucdavis.edu/downloads" class="uri">http://mona.fiehnlab.ucdavis.edu/downloads</a>). <code>CompoundDb</code> allows to process SDF files from:</p>
<ul>
<li>Human Metabolome Database (HMDB), <a href="http://www.hmdb.ca" class="uri">http://www.hmdb.ca</a>
</li>
<li>Chemical Entities of Biological Interest (ChEBI): <a href="https://www.ebi.ac.uk/chebi" class="uri">https://www.ebi.ac.uk/chebi</a>
</li>
<li>LIPID MAPS Structure Database (LMSD): <a href="http://www.lipidmaps.org" class="uri">http://www.lipidmaps.org</a>
</li>
<li>PubChem: <a href="https://pubchem.ncbi.nlm.nih.gov" class="uri">https://pubchem.ncbi.nlm.nih.gov</a>
</li>
<li>MoNa (Massbank of North America): <a href="http://mona.fiehnlab.ucdavis.edu" class="uri">http://mona.fiehnlab.ucdavis.edu</a> (for MoNa import see the next section).</li>
</ul>
<p>Note however that it is also possible to define such a table manually and use that to create the database. See the help page of <code>createCompDb</code> for more details on that.</p>
<p>Below we use the <code>compound_tbl_sdf</code> to extract compound annotations from a SDF file representing a very small subset of the HMDB database. To generate a database for the full HMDB we would have to download the <em>structures.sdf</em> file containing all metabolites and load that file instead.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EuracBiomedicalResearch/CompoundDb">CompoundDb</a></span><span class="op">)</span>

<span class="co">## Locate the file</span>
<span class="va">hmdb_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"sdf/HMDB_sub.sdf.gz"</span>, package <span class="op">=</span> <span class="st">"CompoundDb"</span><span class="op">)</span>
<span class="co">## Extract the data</span>
<span class="va">cmps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compound_tbl_sdf.html">compound_tbl_sdf</a></span><span class="op">(</span><span class="va">hmdb_file</span><span class="op">)</span></code></pre></div>
<p>The function returns by default a (<code>data.frame</code>-equivalent) <code>tibble</code> (from the <em>tidyverse</em>’s <code>tibble</code> package).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cmps</span></code></pre></div>
<pre><code>## # A tibble: 9 x 8
##   compound_id name    inchi      inchikey  formula exactmass synonyms smiles    
##   &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt; &lt;named &gt; &lt;chr&gt;     
## 1 HMDB0000001 1-Meth… InChI=1S/… BRMWTNUJ… C7H11N…     169.  &lt;chr [9… "CN1C=NC(…
## 2 HMDB0000002 1,3-Di… InChI=1S/… XFNJVJPL… C3H10N2      74.1 &lt;chr [8… "NCCCN"   
## 3 HMDB0000005 2-Keto… InChI=1S/… TYEYBOSB… C4H6O3      102.  &lt;chr [3… "CCC(=O)C…
## 4 HMDB0000008 2-Hydr… InChI=1S/… AFENDNXG… C4H8O3      104.  &lt;chr [2… "CCC(O)C(…
## 5 HMDB0000010 2-Meth… InChI=1S/… WHEUWNKS… C19H24…     300.  &lt;chr [7… "[H][C@@]…
## 6 HMDB0000011 (R)-3-… InChI=1S/… WHBMMWSB… C4H8O3      104.  &lt;chr [2… "C[C@@H](…
## 7 HMDB0000012 Deoxyu… InChI=1S/… MXHRCPNR… C9H12N…     228.  &lt;chr [1… "OC[C@H]1…
## 8 HMDB0004370 N-Meth… InChI=1S/… NCIKQJBV… C11H14…     174.  &lt;chr [9… "CNCCC1=C…
## 9 HMDB0006719 5,6-tr… InChI=1S/… QYSXJUFS… C27H44O     384.  &lt;chr [4… "CC(C)CCC…</code></pre>
<p>The <code>tibble</code> contains columns</p>
<ul>
<li>
<code>compound_id</code>: the resource-specific ID of the compound.</li>
<li>
<code>name</code>: the name of the compound, mostly a generic or common name.</li>
<li>
<code>inchi</code>: the compound’s inchi.</li>
<li>
<code>inchikey</code>: the INCHI key.</li>
<li>
<code>formula</code>: the chemical formula of the compound.</li>
<li>
<code>exactmass</code>: the compounds (monoisotopic) mass.</li>
<li>
<code>synonyms</code>: a <code>list</code> of aliases/synonyms for the compound.</li>
<li>
<code>smiles</code>: the SMILES of the compound.</li>
</ul>
<p>To create a simple compound database, we could pass this <code>tibble</code> along with additional required metadata information to the <code>createCompDb</code> function. In the present example we want to add however also MS/MS spectrum data to the database. We thus load below the MS/MS spectra for some of the compounds from the respective xml files downloaded from HMDB. To this end we pass the path to the folder in which the files are located to the <code>msms_spectra_hmdb</code> function. The function identifies the xml files containing MS/MS spectra based on their their file name and loads the respective spectrum data. The folder can therefore also contain other files, but the xml files from HMDB should not be renamed or the function will not recognice them. Note also that at present only MS/MS spectrum xml files from HMDB are supported (one xml file per spectrum); these could be downloaded from HMDB with the <em>hmdb_all_spectra.zip</em> file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Locate the folder with the xml files</span>
<span class="va">xml_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"xml"</span>, package <span class="op">=</span> <span class="st">"CompoundDb"</span><span class="op">)</span>
<span class="va">spctra</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msms_spectra_hmdb.html">msms_spectra_hmdb</a></span><span class="op">(</span><span class="va">xml_path</span><span class="op">)</span></code></pre></div>
<p>Also here, spectra information can be manually provided by adhering to the expected structure of the <code>data.frame</code> (see <code><a href="../reference/createCompDb.html">?createCompDb</a></code> for details).</p>
<p>At last we have to create the metadata for the resource. The metadata information for a <code>CompDb</code> resource is crucial as it defines the origin of the annotations and its version. This information should thus be carefully defined by the user. Below we use the <code>make_metadata</code> helper function to create a <code>data.frame</code> in the expected format. The organism should be provided in the format e.g. <code>"Hsapiens"</code> for human or <code>"Mmusculus"</code> for mouse, i.e. capital first letter followed by lower case characters without whitespaces.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">metad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createCompDb.html">make_metadata</a></span><span class="op">(</span>source <span class="op">=</span> <span class="st">"HMDB"</span>, url <span class="op">=</span> <span class="st">"http://www.hmdb.ca"</span>,
                       source_version <span class="op">=</span> <span class="st">"4.0"</span>, source_date <span class="op">=</span> <span class="st">"2017-09"</span>,
                       organism <span class="op">=</span> <span class="st">"Hsapiens"</span><span class="op">)</span></code></pre></div>
<p>With all the required data ready we create the SQLite database for the HMDB subset. With <code>path</code> we specify the path to the directory in which we want to save the database. This defaults to the current working directory, but for this example we save the database into a temporary folder.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">db_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createCompDb.html">createCompDb</a></span><span class="op">(</span><span class="va">cmps</span>, metadata <span class="op">=</span> <span class="va">metad</span>, msms_spectra <span class="op">=</span> <span class="va">spctra</span>,
                        path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The variable <code>db_file</code> is now the file name of the SQLite database. We can pass this file name to the <code>CompDb</code> function to get the <code>CompDb</code> objects acting as the interface to the database.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cmpdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompDb.html">CompDb</a></span><span class="op">(</span><span class="va">db_file</span><span class="op">)</span>
<span class="va">cmpdb</span></code></pre></div>
<pre><code>## class: CompDb 
##  data source: HMDB 
##  version: 4.0 
##  organism: Hsapiens 
##  compound count: 9 
##  MS/MS spectra count: 4</code></pre>
<p>To extract all compounds from the database we can use the <code>compounds</code> function. The parameter <code>columns</code> allows to choose the database columns to return. Any columns for any of the database tables are supported. To get an overview of available database tables and their columns, the <code>tables</code> function can be used:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/CompDb.html">tables</a></span><span class="op">(</span><span class="va">cmpdb</span><span class="op">)</span></code></pre></div>
<pre><code>## $ms_compound
## [1] "compound_id" "name"        "inchi"       "inchikey"    "formula"    
## [6] "exactmass"   "smiles"     
## 
## $msms_spectrum
##  [1] "original_spectrum_id" "compound_id"          "polarity"            
##  [4] "collision_energy"     "predicted"            "splash"              
##  [7] "instrument_type"      "instrument"           "precursor_mz"        
## [10] "spectrum_id"          "msms_mz_range_min"    "msms_mz_range_max"   
## 
## $msms_spectrum_peak
## [1] "spectrum_id" "mz"          "intensity"   "peak_id"    
## 
## $synonym
## [1] "compound_id" "synonym"</code></pre>
<p>Below we extract only selected columns from the <em>compounds</em> table.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">compounds</span><span class="op">(</span><span class="va">cmpdb</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"name"</span>, <span class="st">"formula"</span>, <span class="st">"exactmass"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##                        name   formula exactmass
## 1 (R)-3-Hydroxybutyric acid    C4H8O3  104.0473
## 2        1,3-Diaminopropane   C3H10N2   74.0844
## 3         1-Methylhistidine C7H11N3O2  169.0851
## 4     2-Hydroxybutyric acid    C4H8O3  104.0473
## 5        2-Ketobutyric acid    C4H6O3  102.0317
## 6          2-Methoxyestrone  C19H24O3  300.1725
## 7      5,6-trans-Vitamin D3   C27H44O  384.3392
## 8              Deoxyuridine C9H12N2O5  228.0746
## 9        N-Methyltryptamine  C11H14N2  174.1157</code></pre>
<p>Analogously we can use the <code>Spectra</code> function to extract spectrum data from the database. The function returns by default a <code>Spectra</code> object from the <code>R Biocpkg("Spectra")</code> package with all spectra metadata available as <em>spectra variables</em>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: BiocParallel</code></pre>
<pre><code>## Loading required package: ProtGenerics</code></pre>
<pre><code>## 
## Attaching package: 'ProtGenerics'</code></pre>
<pre><code>## The following object is masked from 'package:stats':
## 
##     smooth</code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">cmpdb</span><span class="op">)</span>
<span class="va">sps</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 4 spectra in a MsBackendCompDb backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1        NA        NA        NA
## 2        NA        NA        NA
## 3        NA        NA        NA
## 4        NA        NA        NA
##  ... 26 more variables/columns.
##  data source: HMDB 
##  version: 4.0 
##  organism: Hsapiens</code></pre>
<p>The available <em>spectra variables</em> for the <code>Spectra</code> object can be retrieved with <code>spectraVariables</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                 "rtime"                  
##  [3] "acquisitionNum"          "scanIndex"              
##  [5] "dataStorage"             "dataOrigin"             
##  [7] "centroided"              "smoothed"               
##  [9] "polarity"                "precScanNum"            
## [11] "precursorMz"             "precursorIntensity"     
## [13] "precursorCharge"         "collisionEnergy"        
## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"
## [17] "isolationWindowUpperMz"  "original_spectrum_id"   
## [19] "compound_id"             "collision_energy"       
## [21] "predicted"               "splash"                 
## [23] "instrument_type"         "instrument"             
## [25] "spectrum_id"             "msms_mz_range_min"      
## [27] "msms_mz_range_max"</code></pre>
<p>Individual spectra variables can be accessed with the <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> operator:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span><span class="op">$</span><span class="va">collision_energy</span></code></pre></div>
<pre><code>## [1] "10" "25" NA   "20"</code></pre>
<p>And the actual m/z and intensity values with <code>mz</code> and <code>intensity</code>:</p>
<pre class="{r"><code>mz(sps)

## m/z of the 2nd spectrum
mz(sps)[[2]]</code></pre>
<p>Note that it is also possible to retrieve specific spectra, e.g. for a provided compound, or add compound annotations to the <code>Spectra</code> object. Below we use the filter expression <code>~ compound_id == "HMDB0000001"</code>to get only MS/MS spectra for the specified compound. In addition we ask for the <code>"name"</code> and <code>"inchikey"</code> of the compound.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">cmpdb</span>, filter <span class="op">=</span> <span class="op">~</span> <span class="va">compound_id</span> <span class="op">==</span> <span class="st">"HMDB0000001"</span>,
               columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/CompDb.html">tables</a></span><span class="op">(</span><span class="va">cmpdb</span><span class="op">)</span><span class="op">$</span><span class="va">msms_spectrum</span>, <span class="st">"name"</span>,
                           <span class="st">"inchikey"</span><span class="op">)</span><span class="op">)</span>
<span class="va">sps</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 2 spectra in a MsBackendCompDb backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1        NA        NA        NA
## 2        NA        NA        NA
##  ... 28 more variables/columns.
##  data source: HMDB 
##  version: 4.0 
##  organism: Hsapiens</code></pre>
<p>The available spectra variables:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                 "rtime"                  
##  [3] "acquisitionNum"          "scanIndex"              
##  [5] "dataStorage"             "dataOrigin"             
##  [7] "centroided"              "smoothed"               
##  [9] "polarity"                "precScanNum"            
## [11] "precursorMz"             "precursorIntensity"     
## [13] "precursorCharge"         "collisionEnergy"        
## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"
## [17] "isolationWindowUpperMz"  "original_spectrum_id"   
## [19] "compound_id"             "collision_energy"       
## [21] "predicted"               "splash"                 
## [23] "instrument_type"         "instrument"             
## [25] "spectrum_id"             "msms_mz_range_min"      
## [27] "msms_mz_range_max"       "name"                   
## [29] "inchikey"</code></pre>
<p>The compound’s name and INCHI key have thus also been added as spectra variables:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span><span class="op">$</span><span class="va">inchikey</span></code></pre></div>
<pre><code>## [1] "BRMWTNUJHUMWMS-LURJTMIESA-N" "BRMWTNUJHUMWMS-LURJTMIESA-N"</code></pre>
<p>To share or archive the such created <code>CompDb</code> database, we can also create a dedicated R package containing the annotation. To enable reproducible research, each <code>CompDb</code> package should contain the version of the originating data source in its file name (which is by default extracted from the metadata of the resource). Below we create a <code>CompDb</code> package from the generated database file. Required additional information we have to provide to the function are the package creator/maintainer and its version.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/createCompDb.html">createCompDbPackage</a></span><span class="op">(</span>
    <span class="va">db_file</span>, version <span class="op">=</span> <span class="st">"0.0.1"</span>, author <span class="op">=</span> <span class="st">"J Rainer"</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>,
    maintainer <span class="op">=</span> <span class="st">"Johannes Rainer &lt;johannes.rainer@eurac.edu&gt;"</span><span class="op">)</span></code></pre></div>
<pre><code>## Creating package in /tmp/Rtmp0VRklR/CompDb.Hsapiens.HMDB.4.0</code></pre>
<p>The function creates a folder (in our case in a temporary directory) that can be build and installed with <code>R CMD build</code> and <code>R CMD INSTALL</code>.</p>
<p>Special care should also be put on the license of the package that can be passed with the <code>license</code> parameter. The license of the package and how and if the package can be distributed will depend also on the license of the originating resource.</p>
</div>
<div id="create-a-compdb-object-for-mona" class="section level1">
<h1 class="hasAnchor">
<a href="#create-a-compdb-object-for-mona" class="anchor"></a>Create a <code>CompDb</code> object for MoNa</h1>
<p>MoNa (Massbank of North America) provides a large SDF file with all spectra which can be used to create a <code>CompDb</code> object with compound information and MS/MS spectra. Note however that MoNa is organized by spectra and the annotation of the compounds is not consistent and normalized. Spectra from the same compound can have their own compound identified and data that e.g. can differ in their chemical formula, precision of their exact mass or other fields.</p>
<p>Similar to the example above, compound annotations can be imported with the <code>compound_tbl_sdf</code> function while spectrum data can be imported with <code>msms_spectra_mona</code>. In the example below we use however the <code>import_mona_sdf</code> that wraps both functions to reads both compound and spectrum data from a SDF file without having to import the file twice. As an example we use a small subset from a MoNa SDF file that contains only 7 spectra.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mona_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"sdf/MoNa_export-All_Spectra_sub.sdf.gz"</span>,
                        package <span class="op">=</span> <span class="st">"CompoundDb"</span><span class="op">)</span>
<span class="va">mona_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_mona_sdf.html">import_mona_sdf</a></span><span class="op">(</span><span class="va">mona_sub</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: MoNa data can currently not be normalized and the compound table
## contains thus highly redundant data.</code></pre>
<p>As a result we get a <code>list</code> with a data.frame each for compound and spectrum information. These can be passed along to the <code>createCompDb</code> function to create the database (see below).</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">metad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createCompDb.html">make_metadata</a></span><span class="op">(</span>source <span class="op">=</span> <span class="st">"MoNa"</span>,
                       url <span class="op">=</span> <span class="st">"http://mona.fiehnlab.ucdavis.edu/"</span>,
                       source_version <span class="op">=</span> <span class="st">"2018.11"</span>, source_date <span class="op">=</span> <span class="st">"2018-11"</span>,
                       organism <span class="op">=</span> <span class="st">"Unspecified"</span><span class="op">)</span>
<span class="va">mona_db_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createCompDb.html">createCompDb</a></span><span class="op">(</span><span class="va">mona_data</span><span class="op">$</span><span class="va">compound</span>, metadata <span class="op">=</span> <span class="va">metad</span>,
                             msms_spectra <span class="op">=</span> <span class="va">mona_data</span><span class="op">$</span><span class="va">msms_spectrum</span>,
                             path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We can now load and use this database, e.g. by extracting all compounds as shown below.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mona</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompDb.html">CompDb</a></span><span class="op">(</span><span class="va">mona_db_file</span><span class="op">)</span>
<span class="fu">compounds</span><span class="op">(</span><span class="va">mona</span><span class="op">)</span></code></pre></div>
<pre><code>##                   name
## 1 Sulfachlorpyridazine
## 2         Sulfaclozine
## 3        Sulfadimidine
## 4       Sulfamethazine
## 5       Sulfamethazine
##                                                                                                      inchi
## 1             InChI=1S/C10H9ClN4O2S/c11-9-5-6-10(14-13-9)15-18(16,17)8-3-1-7(12)2-4-8/h1-6H,12H2,(H,14,15)
## 2             InChI=1S/C10H9ClN4O2S/c11-9-5-13-6-10(14-9)15-18(16,17)8-3-1-7(12)2-4-8/h1-6H,12H2,(H,14,15)
## 3 InChI=1S/C12H14N4O2S/c1-8-7-9(2)15-12(14-8)16-19(17,18)11-5-3-10(13)4-6-11/h3-7H,13H2,1-2H3,(H,14,15,16)
## 4 InChI=1S/C12H14N4O2S/c1-8-7-9(2)15-12(14-8)16-19(17,18)11-5-3-10(13)4-6-11/h3-7H,13H2,1-2H3,(H,14,15,16)
## 5 InChI=1S/C12H14N4O2S/c1-8-7-9(2)15-12(14-8)16-19(17,18)11-5-3-10(13)4-6-11/h3-7H,13H2,1-2H3,(H,14,15,16)
##                      inchikey      formula exactmass smiles
## 1 XOXHILFPRYWFOD-UHFFFAOYSA-N C10H9ClN4O2S  284.0135   &lt;NA&gt;
## 2 QKLPUVXBJHRFQZ-UHFFFAOYSA-N C10H9ClN4O2S  284.0135   &lt;NA&gt;
## 3 ASWVTGNCAZCNNR-UHFFFAOYSA-N  C12H14N4O2S  278.0837   &lt;NA&gt;
## 4 ASWVTGNCAZCNNR-UHFFFAOYSA-N  C12H14N4O2S  278.0837   &lt;NA&gt;
## 5 ASWVTGNCAZCNNR-UHFFFAOYSA-N  C12H14N4O2S  278.0837   &lt;NA&gt;</code></pre>
<p>As stated in the introduction of this section the <code>compound</code> information contains redundant information and the table has essentially one row per spectrum. Feedback on how to reduce the redundancy in the ms_compound table is highly appreciated.</p>
</div>
<div id="session-information" class="section level1">
<h1 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session information</h1>
<pre><code>## R Under development (unstable) (2021-01-07 r79806)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.1 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
## [1] Spectra_1.1.11          ProtGenerics_1.23.6     BiocParallel_1.25.2    
## [4] CompoundDb_0.8.0        S4Vectors_0.29.6        BiocGenerics_0.37.0    
## [7] AnnotationFilter_1.15.0 BiocStyle_2.19.1       
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.5             png_0.1-7              rsvg_2.1              
##  [4] utf8_1.1.4             assertthat_0.2.1       rprojroot_2.0.2       
##  [7] digest_0.6.27          R6_2.5.0               GenomeInfoDb_1.27.3   
## [10] RSQLite_2.2.2          evaluate_0.14          ChemmineR_3.43.1      
## [13] ggplot2_3.3.3          pillar_1.4.7           zlibbioc_1.37.0       
## [16] rlang_0.4.10           lazyeval_0.2.2         blob_1.2.1            
## [19] MetaboCoreUtils_0.0.3  DT_0.17                rmarkdown_2.6         
## [22] pkgdown_1.6.1.9000     textshaping_0.2.1      desc_1.2.0            
## [25] stringr_1.4.0          htmlwidgets_1.5.3      bit_4.0.4             
## [28] RCurl_1.98-1.2         munsell_0.5.0          compiler_4.1.0        
## [31] xfun_0.20              pkgconfig_2.0.3        systemfonts_0.3.2     
## [34] base64enc_0.1-3        htmltools_0.5.0        tidyselect_1.1.0      
## [37] tibble_3.0.4           gridExtra_2.3          GenomeInfoDbData_1.2.4
## [40] bookdown_0.21          IRanges_2.25.6         fansi_0.4.1           
## [43] dbplyr_2.0.0           crayon_1.3.4           dplyr_1.0.2           
## [46] MASS_7.3-53            bitops_1.0-6           grid_4.1.0            
## [49] jsonlite_1.7.2         gtable_0.3.0           lifecycle_0.2.0       
## [52] DBI_1.1.0              magrittr_2.0.1         MsCoreUtils_1.3.2     
## [55] scales_1.1.1           cli_2.2.0              stringi_1.5.3         
## [58] XVector_0.31.1         fs_1.5.0               xml2_1.3.2            
## [61] ellipsis_0.3.1         ragg_0.4.1             generics_0.1.0        
## [64] vctrs_0.3.6            rjson_0.2.20           tools_4.1.0           
## [67] bit64_4.0.5            Biobase_2.51.0         glue_1.4.2            
## [70] purrr_0.3.4            yaml_2.2.1             colorspace_2.0-0      
## [73] BiocManager_1.30.10    GenomicRanges_1.43.1   memoise_1.1.0         
## [76] knitr_1.30</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jan Stanstrup, Johannes Rainer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
